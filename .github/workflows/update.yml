name: Update eden

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Get latest release
        id: release
        run: |
          RELEASE=$(curl -s https://api.github.com/repos/eden-emulator/Releases/releases/latest)
          VERSION=$(echo "$RELEASE" | jq -r '.tag_name' | sed 's/^v//')
          URL=$(echo "$RELEASE" | jq -r '.assets[].browser_download_url' \
            | grep -i 'linux.*amd64.*\.AppImage$' \
            | grep -iv 'zsync\|clang\|pgo' \
            | head -1)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"
          echo "Found URL: $URL"

      - name: Check if update needed
        id: check
        run: |
          CURRENT=$(grep 'version = ' pkgs/eden/default.nix | head -1 | grep -oP '".*?"' | tr -d '"')
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          if [ "$CURRENT" = "${{ steps.release.outputs.version }}" ]; then
            echo "needed=false" >> $GITHUB_OUTPUT
          else
            echo "needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Fetch new hash
        id: hash
        if: steps.check.outputs.needed == 'true'
        run: |
          HASH=$(nix-prefetch-url --type sha256 "${{ steps.release.outputs.url }}" 2>/dev/null)
          SRI=$(nix hash to-sri --type sha256 "$HASH")
          echo "hash=$SRI" >> $GITHUB_OUTPUT

      - name: Update default.nix
        if: steps.check.outputs.needed == 'true'
        run: |
          sed -i "s|version = \".*\";|version = \"${{ steps.release.outputs.version }}\";|" pkgs/eden/default.nix
          sed -i "s|url = \".*AppImage\";|url = \"${{ steps.release.outputs.url }}\";|" pkgs/eden/default.nix
          sed -i "s|hash = \".*\";|hash = \"${{ steps.hash.outputs.hash }}\";|" pkgs/eden/default.nix

      - name: Build
        id: build
        if: steps.check.outputs.needed == 'true'
        run: nix build .#packages.x86_64-linux.eden
        continue-on-error: true

      - name: Create PR
        if: steps.check.outputs.needed == 'true' && steps.build.outcome == 'success'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "eden: update to ${{ steps.release.outputs.version }}"
          title: "eden: update to ${{ steps.release.outputs.version }}"
          body: "Automated update. Build passed."
          branch: "auto-update/eden"
          delete-branch: true
          labels: auto-update

  automerge:
    runs-on: ubuntu-latest
    needs: update
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_LABELS: "auto-update"
          MERGE_METHOD: squash
          MERGE_COMMIT_MESSAGE: pull-request-title
          MERGE_DELETE_BRANCH: "true"
